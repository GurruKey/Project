# Security  базовые правила (черновик)

## 1) Аутентификация и сессии
- Supabase Auth: access (короткий TTL) + refresh (продление).
- Не класть чувствительные данные в payload/JWT.
- Для будущего SSR/edge: куки HttpOnly + Secure + SameSite=Lax/Strict.

## 2) Ключи и переменные окружения
- Клиент: только VITE_*. VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY  из Project Settings  API.
- Сервер: SUPABASE_SERVICE_ROLE_KEY  ТОЛЬКО на сервере/в edge-функциях (не в клиенте/репо).
- Не хранить секреты в git. Локальные окружения  в .env.local (игнорится).

## 3) RLS (Row Level Security)  с первого дня
- Для всех пользовательских таблиц включён RLS.
- Политики (policy) опираются на uth.uid() и роль пользователя.
- Админские операции  через серверный ключ + отдельные политики.

## 4) RBAC и минимально необходимые права
- Роли: Owner/Admin/Moderator/User (детали см. docs/rbac.md).
- Принцип наименьших привилегий: доступ только к нужным сущностям/операциям.
- Все админ-действия логируются.

## 5) Аудит и журналирование
- Таблица udit_logs: кто/что/когда (+ контекст).
- Минимальный набор событий: регистрация/логин/логаут, смена e-mail/телефона/пароля, изменения ролей.
- Retention-политика: хранение логов и данных  определить под регион.

## 6) Защита приложения
- XSS: безопасный рендер, экранирование, запрет опасных инлайнов.
- Rate limiting: на логин/ввод промокодов/бонусные действия.
- Anti-abuse: базовые velocity-чекеры на частые вызовы.
- CSP/Headers: подключить при сборке сервера/хостинге.

## 7) Хранение и шифрование
- At rest: использовать шифрование на уровне провайдера/БД.
- In transit: HTTPS везде.
- Hashing паролей: современная функция (например, bcrypt/argon2)  это часть Supabase Auth.

## 8) Инциденты и бэкапы
- Бэкапы БД: регулярные, проверка восстановления.
- Инциденты: фиксация, пост-морем, план восстановления.
